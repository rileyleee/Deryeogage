# ì„œë¹„ìŠ¤ ë°°í¬ ë©”ë‰´ì–¼

<details>
<summary>ê¸°ìˆ  ìŠ¤íƒ</summary>
<div markdown="1">       

#### ğŸ“Œ í”„ë¡ íŠ¸ ì—”ë“œ
- react 18.2.0
- nodejs 14.0.0
- npm 9.6.7
- redux 4.2.1
- recoil 0.7.7
- react-bootstrap 2.8.0

#### ğŸ“Œ ë°±ì—”ë“œ
- jdk 11.0.2
- gradle 8.1.1
- springboot 2.7.14
- mysql 8.0.33 

#### ğŸ“Œ ì¸í”„ë¼
- docker 24.0.5
- docker-compose 2.1.0
- apt 2.0.9
- nginx 1.18.0
- jenkins lts

</div>
</details>

---

<details>
<summary>ë„ì»¤ ì„¤ì¹˜ ë° ì„¤ì •</summary>
<div markdown="1">       

### 1. ê¸°ì¡´ ë„ì»¤ íŒ¨í‚¤ì§€ ì œê±°
```bash
sudo apt-get remove docker docker-engine docker.io containerd runc
```
ê¸°ì¡´ì— ì„¤ì¹˜í•œ ë„ì»¤ íŒ¨í‚¤ì§€ê°€ ìˆë‹¤ë©´ ì‚­ì œí•´ì£¼ë„ë¡ í•œë‹¤.

### 2. íŒ¨í‚¤ì§€ ì„¤ì¹˜
```bash
sudo apt-get update
sudo apt-get install \
    apt-transport-https \
    ca-certificates \
    curl \
    gnupg \
    lsb-release
```

### 3. ë„ì»¤ ê³µì‹ GPGí‚¤ ì¶”ê°€
```bash
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
```

### 4. ë„ì»¤ ì €ì¥ì†Œ ì„¤ì •
```bash
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
```

### 5. ë„ì»¤ íŒ¨í‚¤ì§€ ì„¤ì¹˜
```bash
sudo apt-get update
sudo apt-get install docker-ce docker-ce-cli containerd.io
```

### 6. ë„ì»¤ ì„œë¹„ìŠ¤ ì‹œì‘ ë° ìë™ ì‹œì‘ ì„¤ì •
```bash
sudo systemctl start docker
sudo systemctl enable docker
```

### 7. ë„ì»¤ ë²„ì „ í™•ì¸
```bash
sudo docker --version
```

---

### 1. Docker-compose ì„¤ì¹˜
```bash
sudo curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
```

### 2. ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
```bash
sudo chmod +x /usr/local/bin/docker-compose
```
ë‹¤ìš´ë¡œë“œ ë°›ì€ íŒŒì¼ì— ì‹¤í–‰ ê¶Œí•œì„ ë¶€ì—¬í•œë‹¤. <br>
ë²„ì „ í™•ì¸ì€ ë„ì»¤ì™€ ë™ì¼í•¨.

</div>
</details>

---

<details>
<summary>nginx ì„¤ì¹˜ ë° ì„¤ì •</summary>
<div markdown="1">       

### 1. nginx ì„¤ì¹˜
```bash
sudo apt install nginx
```

### 2. nginx status í™•ì¸
```bash
 sudo systemctl status nginx
```
Active ìƒíƒœê°€ running ì´ë¼ë©´ ì‹¤í–‰ ì¤‘ì¸ ìƒíƒœì´ë‹¤.

### 3. nginx ì‹¤í–‰ / ì¤‘ë‹¨
```bash
sudo systemctl start nginx
sudo systemctl stop nginx
```

### 4. nginx ì „ì—­ ì„¤ì • íŒŒì¼
```bash
sudo vi /etc/nginx/nginx.conf
```

#### ì „ì—­ ì„¤ì • íŒŒì¼
![ì „ì—­ ì„¤ì • íŒŒì¼](/exec/images/nginx_conf.PNG)
- includeë¥¼ í†µí•´ ê°œë³„ ì„¤ì • íŒŒì¼ì¸ drgg.conf íŒŒì¼ ì ìš©

#### ê°œë³„ ì„¤ì • íŒŒì¼
```bash
vi /etc/nginx/sites-available/drgg.conf
```

![ê°œë³„ ì„¤ì • íŒŒì¼](/exec/images/drgg_conf.PNG)
- ë¦¬ë²„ìŠ¤ í”„ë¡ì‹± ì„¤ì •ì„ í•´ì¤€ë‹¤.
- / ë¡œ ë“¤ì–´ì˜¤ëŠ” ìš”ì²­ì€ 3000ë²ˆ í¬íŠ¸ë¥¼ ì‚¬ìš©ì¤‘ì¸ ë¦¬ì•¡íŠ¸
- /api ë¡œ ë“¤ì–´ì˜¤ëŠ” ìš”ì²­ì€ 8082 í¬íŠ¸ë¥¼ ì‚¬ìš©ì¤‘ì¸ ìŠ¤í”„ë§ë¶€íŠ¸
- /wsì—­ì‹œ ë™ì¼

#### ì‹¬ë³¼ë¦­ ë§í¬ ìƒì„±
```bash
sudo ln -s /etc/nginx/sites-available/drgg.conf /etc/nginx/sites-enabled/
```

### 5. SSL ì„¤ì •

#### let's encrypt ì„¤ì¹˜
```bash
sudo apt-get install letsencrypt
```

#### Certbot ì„¤ì¹˜
```bash
sudo apt-get install certbot python3-certbot-nginx
```

#### Certbot ë™ì‘
```bash
sudo certbot --nginx
```
- ì´ë©”ì¼ ì…ë ¥
- ì•½ê´€ ë™ì˜ -y
- ì´ë©”ì¼ ë°œì†¡ ë™ì˜ -y / -n
- ë„ë©”ì¸ ì…ë ¥

</div>
</details>

---

<details>
<summary>ë°°í¬ ì„¤ì •</summary>
<div markdown="1">     

### 0. EC2 í™˜ê²½ ë‚´ ë°°í¬ í´ë” êµ¬ì¡°
```bash
â”œâ”€â”€ deploy
â”‚Â Â  â”œâ”€â”€ back
â”‚Â Â  â”‚ Â Â    â””â”€â”€ ìŠ¤í”„ë§ë¶€íŠ¸ í”„ë¡œì íŠ¸ íŒŒì¼ë“¤
â”‚Â Â  â”œâ”€â”€ docker-compose.yml
â”‚Â Â  â”œâ”€â”€ front
â”‚   â”‚      â””â”€â”€ ë¦¬ì•¡íŠ¸ í”„ë¡œì íŠ¸ íŒŒì¼ë“¤
```

### 1.  í”„ë¡ íŠ¸ì—”ë“œ 

#### Dockerfile
```docker
#base image ì„¤ì •
FROM node:14-alpine as build

#ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

#app dependencies
COPY package*.json ./

#pakage.json ë° pakage-lock.json íŒŒì¼ì— ëª…ì‹œëœ ì˜ì¡´ì„± íŒ¨í‚¤ì§€ë“¤ì„ ì„¤ì¹˜
RUN npm install

#í˜¸ìŠ¤íŠ¸ ë¨¸ì‹ ì˜ í˜„ì¬ ë””ë ‰í† ë¦¬ íŒŒì¼ë“¤ì„ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ë¡œ ì „ë¶€ ë³µì‚¬
COPY . .

#run build
RUN npm run build

#prod enviroment
FROM nginx:stable-alpine

#ì´ì „ ë¹Œë“œ ë‹¨ê³„ì—ì„œ ë¹Œë“œí•œ ê²°ê³¼ë¬¼ì„ /usr/share/nginx/htmlë¡œ ë³µì‚¬í•œë‹¤.
COPY --from=build /app/build /usr/share/nginx/html

# ê¸°ë³¸ NGINX ì„¤ì • íŒŒì¼ì„ ì‚­ì œí•œë‹¤. (custom ì„¤ì •ê³¼ ì¶©ëŒ ë°©ì§€)
RUN rm /etc/nginx/conf.d/default.conf

#custom ì„¤ì •íŒŒì¼ì„ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ë¡œ ë³µì‚¬í•œë‹¤.
COPY nginx.conf /etc/nginx/conf.d

#ì»¨í…Œì´ë„ˆì˜ 3000ë²ˆ í¬íŠ¸ë¥¼ ì—´ì–´ì¤€ë‹¤.
EXPOSE 3000

#nginx ì„œë²„ë¥¼ ì‹¤í–‰í•˜ê³  ë°±ê·¸ë¼ìš´ë“œë¡œ ë™ì‘í•˜ë„ë¡
CMD ["nginx", "-g", "daemon off;"]
```

#### nginx.conf
```nginx
server {
    listen 3000;
    location / {
        root /usr/share/nginx/html;
        index index.html index.html;
        try_files $uri $uri/ /index.html;
    }
}
```
- ë‚´ë¶€ ì„œë¹™ìš© nginx ì„¤ì •

---

### 2. ë°±ì—”ë“œ 

#### Dockerfile
```docker
FROM openjdk:11-jdk
ARG JAR_FILE=build/libs/*.jar
COPY ${JAR_FILE} app.jar
EXPOSE 8080
ENTRYPOINT ["java", "-jar", "/app.jar"]
```

---

### 3. docker-compose.yml

#### ë°°ì¹˜ íŒŒì¼ ìƒì„±
```bash
sudo vi drgg-deploy.sh
```
```bash
version: '3'
services:
  react:
    build:
      context: ./front
      dockerfile: Dockerfile
    image: react
    environment:
            TZ: "Asia/Seoul"
    container_name: react
    ports:
            - "3000:3000"

  springboot:
     build:
        context: ./back
        dockerfile: Dockerfile
     image: springboot
     environment:
             TZ: "Asia/Seoul"
     container_name: springboot
     ports:
             - "8082:8082"
```
     

</div>
</details>

---

<details>
<summary>CI/CD êµ¬ì¶•</summary>
<div markdown="1">       

### 1.  Jenkins ì„¤ì¹˜

#### Docker Hubì—ì„œ Jenkins ìµœì‹  ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
```bash
docker pull jenkins/jenkins:lts
```

#### Jenkins ì»¨í…Œì´ë„ˆ ì‹¤í–‰
```bash
docker run -d -p 8080:8080 -p 50000:50000 jenkins/jenkins:lts
```

#### ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ í™•ì¸
```bash
docker ps
```
![ì  í‚¨ìŠ¤](/exec/images/jenkins_container.PNG)

#### Jenkins ì ‘ì†
- ì£¼ì†Œì°½ì— http://[public_ip_ì£¼ì†Œ]:8080
- admin password í™•ì¸ ë°©ë²•
    ```bash
    docker logs -f jenkins
    ```
    ![ë¡œê·¸ í™”ë©´](/exec/images/jenkins_admin-key.PNG)

### 2. ì  í‚¨ìŠ¤ í™˜ê²½ì„¤ì •
- ê¸°ë³¸ì ì¸ íšŒì›ê°€ì… (ì‰¬ìš´ ID, PWD âŒ)
- ì¶”ì²œ í”ŒëŸ¬ê·¸ì¸ ë‹¤ìš´ë¡œë“œ (GitLab í•„ìˆ˜)
- Jenkins Credential ì„¤ì •
  - Jenkins ê´€ë¦¬ / Credentials / global ë“¤ì–´ê°„ í›„ +add credential í´ë¦­
  - Username with password or Personal Access Token ì¸ì¦
    - Personal Access Tokenì˜ ê²½ìš°ì—” GitLabì—ì„œ ê°€ì ¸ì˜¨ í›„ í† í°ì„ ë¹„ë°€ë²ˆí˜¸ ëŒ€ì‹ ìœ¼ë¡œ ì‚¬ìš©
  
### 3. ì  í‚¨ìŠ¤ í”„ë¡œì íŠ¸ ìƒì„±
- ìƒˆë¡œìš´ item í´ë¦­ í›„ í”„ë¡œì íŠ¸ ì œëª© ì…ë ¥, pipeline í´ë¦­
- GitLab Connection ë“±ë¡
  - Jenkins ê´€ë¦¬ / System 
  - GitLab íƒ­ ì…ë ¥ì‚¬í•­ ì…ë ¥

### 4. Pipeline Script ì‘ì„±
```bash
pipeline {
    agent any
    stages {
        stage('Git Clone') {
            steps {
                git branch: 'master', credentialsId: 'drgg' ,  url: 'https://lab.ssafy.com/s09-webmobile1-sub2/S09P12B307.git'
            }
        }
        stage('FE-build') {
            steps {
                dir("./Front") {
                    nodejs(nodeJSInstallationName: 'nodejs') {
                        // sh 'npm install && npm run build'
                        sh 'CI=false npm install && CI=false npm run build'
                    }
                }
            }
        }
        stage('BE-build') {
            steps {
                dir("./Back") {
                    sh 'chmod +x ./gradlew'
                    sh './gradlew clean build'
                }
            }
        }
        stage('Compression-FE') {
            steps {
                dir('./Front') {
                    sh '''
                    rm -rf node_modules
                    tar -cvf drgg_front_0.1.0.tar .
                    '''
                }
            }
        }
        stage('Compression-BE') {
            steps {
                dir('./Back') {
                    sh '''
                    tar -cvf drgg_back_0.1.0.tar .
                    '''
                }
            }
        }
        stage('Deploy') {
            steps {
                sshagent(credentials: ['drgg-ec2']) {
                    sh '''
                        ssh -o StrictHostKeyChecking=no ubuntu@3.38.151.59
                        scp /var/jenkins_home/workspace/drgg-deploy/Front/drgg_front_0.1.0.tar ubuntu@3.38.151.59:/home/ubuntu/deploy/front
                        scp /var/jenkins_home/workspace/drgg-deploy/Back/drgg_back_0.1.0.tar ubuntu@3.38.151.59:/home/ubuntu/deploy/back
                        ssh -t ubuntu@3.38.151.59 ./drgg-deploy.sh
                    '''
                }
                timeout(time: 180, unit: 'SECONDS') {
                }
            }
        }
    }
    post {
            success {
        	    script {
                    def Author_ID = sh(script: "git show -s --pretty=%an", returnStdout: true).trim()
                    def Author_Name = sh(script: "git show -s --pretty=%ae", returnStdout: true).trim()
                    mattermostSend (color: 'good', 
                    message: "ë¹Œë“œ ì„±ê³µ: ${env.JOB_NAME} #${env.BUILD_NUMBER} by ${Author_ID}(${Author_Name})\n(<${env.BUILD_URL}|Details>)", 
                    endpoint: '{endpointì…ë ¥}', 
                    channel: '{channelì…ë ¥}'
                    )
                }
            }
            failure {
        	    script {
                    def Author_ID = sh(script: "git show -s --pretty=%an", returnStdout: true).trim()
                    def Author_Name = sh(script: "git show -s --pretty=%ae", returnStdout: true).trim()
                    mattermostSend (color: 'danger', 
                    message: "ë¹Œë“œ ì‹¤íŒ¨: ${env.JOB_NAME} #${env.BUILD_NUMBER} by ${Author_ID}(${Author_Name})\n(<${env.BUILD_URL}|Details>)", 
                    endpoint: '{endpointì…ë ¥}', 
                    channel: '{channelì…ë ¥}'
                    )
                }
            }
        }
}
```

### 5. ì›¹í›… ì„¤ì •
- GitLabì˜ 'daeryeogage' í”„ë¡œì íŠ¸ setting / webhook
- URL ì…ë ¥ ë° ê³ ê¸‰ í´ë¦­ í›„ ì‹œí¬ë¦¿ í‚¤ GitLabì— ì…ë ¥
- ë¹Œë“œ íŠ¸ë¦¬ê±° 'Push Events', 'Accepted Merge Request Events' ì„ íƒ
- ê³ ê¸‰ íƒ­ì„ í´ë¦­ í›„ 'Filter branches by regex' í´ë¦­
  - `^master$` ì…ë ¥

</div>
</details>

---

<details>
<summary>ê¸°íƒ€ ì„¤ì •</summary>
<div markdown="1">       

#### ë°©í™”ë²½ ê¸°ë³¸ í¬íŠ¸ ì—´ê¸°
```bash
sudo ufw allow http
sudo ufw allow https
sudo ufw allow ssh
sudo ufw enable
```

#### í˜„ì¬ ì‚¬ìš©ì¤‘ì¸ í¬íŠ¸ë²ˆí˜¸ì™€ í”„ë¡œì„¸ìŠ¤ í™•ì¸
```bash
sudo netstat -tulnlp
```

#### ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„± (drgg_deploy.sh)
```bash
#!/bin/bash
echo "ìë™ ë°°í¬ ì‹œì‘"
cd /home/ubuntu/deploy/front
# yes | sudo docker system prune
tar -xvf drgg_front_0.1.0.tar
rm -rf drgg_front_0.1.0.tar
echo "í”„ë¡ íŠ¸ì—”ë“œ ì••ì¶• í’€ê¸° ì™„ë£Œ"

cd /home/ubuntu/deploy/back
# yes | sudo docker system prune
tar -xvf drgg_back_0.1.0.tar
rm -rf drgg_back_0.1.0.tar

sudo docker-compose down
sudo docker-compose up -d --build
echo "ìë™ ë°°í¬ ì™„ë£Œ"
# sudo service nginx restart
```
</div>
</details>


---

<details>
<summary>í™˜ê²½ë³€ìˆ˜</summary>
<div markdown="1">       

### .env
- REACT_APP_GOOGLE_API_KEY : êµ¬ê¸€ë§µ apië¥¼ ì‚¬ìš©í•˜ëŠ”ë° í•„ìš”í•œ í‚¤
- REACT_APP_WEATHER_KEY : ë‚ ì”¨ api ë¥¼ ì‚¬ìš©í•˜ëŠ”ë° í•„ìš”í•œ í‚¤
- REACT_APP_REST_API_KEY : ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ REST API KEY
- REACT_APP_REDIRECT_URL : í˜ì´ì§€ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì£¼ì†Œ
- REACT_APP_API_URL : api ìš”ì²­ url
- REACT_APP_CHAT_URL : ì±„íŒ… api ìš”ì²­ url

---

### application-.properties

#### mysql
```java
spring.datasource.url=jdbc:mysql://3.38.151.59/deryeogage
spring.datasource.username={ì‚¬ìš©ì}
spring.datasource.password={ë¹„ë°€ë²ˆí˜¸}
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
```

#### JPA
```java
spring.jpa.hibernate.ddl-auto=validate
spring.jpa.properties.hibernate.show_sql=false
spring.jpa.properties.hibernate.format_sql=false
```

#### ë¡œê¹… 
```java
logging.level.org.hibernate.SQL=debug
spring.output.ansi.enabled=always
```

#### JWT
```java
security.jwt.token.SK= {JWT ë¹„ë°€í‚¤}
security.jwt.token.tokenValidTime= {JWT ìœ íš¨ê¸°ê°„ ì„¤ì •}
```

#### ê¸°íƒ€ ìŠ¤í”„ë§ë¶€íŠ¸ ì„¤ì •
```java
spring.devtools.livereload.enabled=true
spring.devtools.restart.enabled=false
spring.freemarker.cache=false
spring.jackson.serialization.fail-on-empty-beans=false
```

---

### S3

```java
cloud.aws.s3.bucket={S3 ë²„í‚· ì´ë¦„}
cloud.aws.credentials.access-key={S3 ì•¡ì„¸ìŠ¤ í‚¤}
cloud.aws.credentials.secret-key={S3 ë¹„ë°€ ì•¡ì„¸ìŠ¤ í‚¤}
cloud.aws.region.static=ap-northeast-2
cloud.aws.region.auto=false
cloud.aws.stack.auto=false

logging.level.com.amazonaws.util.EC2MetadataUtils=ERROR

spring.servlet.multipart.max-file-size=1GB
spring.servlet.multipart.max-request-size=3GB
```
</div>
</details>